#!/bin/bash

if [[ $# -ne 3 ]]; then
    echo "Usage: fld-all INPUT-DIR OUTPUT-DIR CONFIG"
    exit 1
fi

DIR="$(dirname "$0")"
PARENT=$(dirname "$DIR")

FASTAS=$(readlink -f "$1")
OUT="$2"
TMP="$OUT/tmp"

CONFIG="$3"
FLD_PAD_ARGS=$(sed -n "1p" $CONFIG)
FLD_BCD_ARGS=$(sed -n "2p" $CONFIG)

if [[ -d $OUT ]]; then
    echo "The directory '$OUT' already exists."
    exit 1
fi

echo
echo "----- Preprocessing -----"
echo

# Preprocess the FASTA files for fld

shopt -s nullglob
files=("$FASTAS"/*.fasta)

if [[ ${#files[@]} -eq 0 ]]; then
    echo "No FASTA files found in $FASTAS."
    exit 1
fi

mkdir -p $TMP
cd $TMP

for file in "${files[@]}"; do
    base=$(basename "$file" .fasta)
    fld preprocess --output "$base.csv" --sublibrary $base $file
done

# Stack the preprocessed CSV files

csvstack *.csv > "preprocessed.csv"

echo
echo "----- Padding -----"
echo

# Add padding but no barcodes

fld design $FLD_PAD_ARGS -o "library" "preprocessed.csv"

echo
echo "----- Generating barcodes -----"
echo

# Generate barcodes

fld barcodes $FLD_BCD_ARGS --count $(wc -l < library.txt) --output barcodes.txt

echo
echo "----- Predicting reads -----"
echo

# Tokenize the text files before running rn-coverage

rn-coverage tokenize library.txt library_t.nc
rn-coverage tokenize barcodes.txt barcodes_t.nc

# Run rn-coverage (preferably on a GPU) with the provided configuration file

rn-coverage predict $PARENT/config/config.yaml

# Merge barcodes and designs

cd ..

echo
echo "----- Generating final library -----"
echo

fld-merge "tmp" "library"

# Double check

fld inspect library.fasta
